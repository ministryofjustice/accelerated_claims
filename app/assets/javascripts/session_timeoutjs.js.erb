/*jslint browser: true, evil: false, plusplus: true, white: true, indent: 2 */
/*global moj, $ */

moj.Modules.sessionTimeout = (function() {
  "use strict";

  var //functions
      init,
      startTimer,
      showPopup,
      refreshSession,
      endSession,

      //vars
      timer = null,
      sessionMinutes = 60,
      warnMinutesBeforeEnd = sessionMinutes / 4,
      elapsedMinutes,
      counter = null,
      minute = 60 * 1000,
      quick = false,
      baseProtocol = window.location.protocol,
      baseDomain = window.location.host,
      baseUrl = '<%= Rails.configuration.relative_url_root %>',
      basePath = baseProtocol + '//' + baseDomain + ( baseUrl === '' ? '' : '/' + baseUrl )
      ;

  init = function() {
    quick = moj.Modules.tools.getQueryVar( 'quick' );

    if( $( 'form#claimForm' ).length > 0 ) {
      if( quick === 'true' ) {
        sessionMinutes = 2;
        warnMinutesBeforeEnd = 1.5;
      } else if( quick === 'very' ) {
        sessionMinutes = 0.15;
        warnMinutesBeforeEnd = 0.1;
      } else if( quick && !isNaN( quick ) ) {
        sessionMinutes = quick;
        warnMinutesBeforeEnd = sessionMinutes / 2;
      }

      startTimer();
    }
  };

  startTimer = function() {
    if( timer ) {
      window.clearTimeout( timer );
      timer = null;
    }
    if( counter ) {
      window.clearInterval( counter );
      counter = null;
    }
    elapsedMinutes = 0

    // moj.log( 'Starting timer. Session will end in ' + sessionMinutes + ' minutes. (' + ( sessionMinutes * 60 ) + ' seconds)' );
    // moj.log( 'Warning will show in ' + ( sessionMinutes - warnMinutesBeforeEnd ) + ' minutes. (' + ( sessionMinutes - warnMinutesBeforeEnd ) * 60 + ' seconds)' );

    timer = window.setTimeout( function() {
      showPopup();
    }, ( sessionMinutes - warnMinutesBeforeEnd ) * minute );

    counter = window.setInterval( function() {
      elapsedMinutes++;
      moj.log( elapsedMinutes + ' minute' + ( elapsedMinutes === 1 ? '' : 's' ) + ' elapsed' );
    }, minute );
  };

  showPopup = function() {
    moj.Modules.sessionModal.showModal( function() {
      refreshSession();
    }, sessionMinutes, warnMinutesBeforeEnd );

    moj.log( 'Warning shown. Session will end in ' + warnMinutesBeforeEnd + ' minutes.' );

    timer = window.setTimeout( function() {
      endSession();
    }, warnMinutesBeforeEnd * minute );
  };

  refreshSession = function() {
    moj.log( 'Refreshing session' );
    $.get( basePath + '/heartbeat', function() {
      moj.Modules.sessionModal.closeModal();
      startTimer();
    } );
  };

  endSession = function() {
    moj.log( 'Ending session' );
    $.ajax( {
      type:     'post',
      url:      basePath + '/expire_session',
      data:     {
        redirect:   false
      },
      success:  function( data, textStatus, jqXHR ) {
        moj.log( textStatus );
        document.location.href = basePath + '/expired';
      },
      error:    function( jqXHR, textStatus, errorThrown ) {
        moj.log( 'error' );
        moj.log( jqXHR );
        moj.log( textStatus );
        moj.log( errorThrown );
      }
    } );
  };

  // public

  return {
    init: init
  };

}());
